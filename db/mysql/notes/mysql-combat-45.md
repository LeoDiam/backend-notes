# MySQL 实战 45 讲

Table of Contents
-----------------

* [1. 一条 SQL 查询语句是如何执行的?](#1-一条-sql-查询语句是如何执行的)
   * [连接器](#连接器)
   * [查询缓存（mysql 8 之后废除, 暂不讨论）](#查询缓存mysql-8-之后废除-暂不讨论)
   * [分析器](#分析器)
   * [优化器](#优化器)
   * [执行器](#执行器)
* [2. 一条 SQL 更新语句是如何执行的?](#2-一条-sql-更新语句是如何执行的)
   * [redo log](#redo-log)
   * [binlog](#binlog)
* [3. 事务隔离: 为什么你改了我还看不见?](#3-事务隔离-为什么你改了我还看不见)
* [4. 深入浅出索引](#4-深入浅出索引)
* [5. 全局锁和表锁: 给表加个字段怎么有那么多阻碍?](#5-全局锁和表锁-给表加个字段怎么有那么多阻碍)
* [6. 怎么减少行锁对性能对影响?](#6-怎么减少行锁对性能对影响)
* [7. 事务到底是隔离的还是不隔离的?](#7-事务到底是隔离的还是不隔离的)
* [8. 普通索引和唯一索引, 应该怎么选择?](#8-普通索引和唯一索引-应该怎么选择)
* [9. MySQL 为什么有时候会选错索引?](#9-mysql-为什么有时候会选错索引)
* [10. 怎么给字符串字段加索引?](#10-怎么给字符串字段加索引)
* [11. 为什么我的 MySQL 会 ”抖“ 一下?](#11-为什么我的-mysql-会-抖-一下)
* [12. 为什么表数据删掉一半, 表文件大小不变?](#12-为什么表数据删掉一半-表文件大小不变)
* [13. count(*) 这么慢, 怎么办?](#13-count-这么慢-怎么办)
* [14. "order by" 如何工作?](#14-order-by-如何工作)
* [15. 如何正确显示随机消息?](#15-如何正确显示随机消息)
* [16. 为什么 SQL 语句逻辑相同, 性能差异却巨大?](#16-为什么-sql-语句逻辑相同-性能差异却巨大)
* [17. 为什么我只查一行的语句, 也执行那么慢?](#17-为什么我只查一行的语句-也执行那么慢)
* [18. 幻读是什么? 有什么问题?](#18-幻读是什么-有什么问题)
* [19. 为什么我只查一行的语句, 锁这么多?](#19-为什么我只查一行的语句-锁这么多)
* [20. 有哪些提高性能的方法?](#20-有哪些提高性能的方法)
* [21. 如何保证数据不丢?](#21-如何保证数据不丢)
* [22. 如何保证主备一致?](#22-如何保证主备一致)
* [23. 如何保证高可用?](#23-如何保证高可用)
* [24. 备库为什么会延迟好几个小时?](#24-备库为什么会延迟好几个小时)
* [25. 主库出问题了, 从库怎么办?](#25-主库出问题了-从库怎么办)
* [26. 读写分离有哪些坑?](#26-读写分离有哪些坑)
* [27. 如何判断一个数据库是不是出问题了?](#27-如何判断一个数据库是不是出问题了)
* [28. 删库除了跑路, 还能怎么办?](#28-删库除了跑路-还能怎么办)
* [29. 为什么还有 kill 不掉的语句?](#29-为什么还有-kill-不掉的语句)
* [30. 我查那么多数据, 会不会把数据库内存打爆？](#30-我查那么多数据-会不会把数据库内存打爆)
* [31. 到底可不可以用 join?](#31-到底可不可以用-join)
* [32. join 语句怎么优化?](#32-join-语句怎么优化)
* [33. 为什么临时表可以重名?](#33-为什么临时表可以重名)
* [34. 什么时候会使用内部临时表?](#34-什么时候会使用内部临时表)
* [35. 还要使用 Memory 引擎吗?](#35-还要使用-memory-引擎吗)
* [36. 自增主键为什么不是连续的?](#36-自增主键为什么不是连续的)
* [37. insert 语句的锁为什么那么多?](#37-insert-语句的锁为什么那么多)
* [38. grant 之后要 flush privileges 吗?](#38-grant-之后要-flush-privileges-吗)
* [39. 怎么最快地复制一张表?](#39-怎么最快地复制一张表)
* [40. 要不要使用分区表?](#40-要不要使用分区表)
* [41. 自增 ID 用完了怎么办?](#41-自增-id-用完了怎么办)
* [参考资料](#参考资料)



## 1. 一条 SQL 查询语句是如何执行的?

大体上，`MySQL` 分为两部分：

- Server 层：涵盖 `MySQL` 大多数核心服务功能
- 存储引擎层：负责数据的存储和提取（插件式）



<div align="center"> <img src="logic.png" width="70%"/> </div><br> 

### 连接器

作用：客户端与 `mysql` 建立连接

```mysql
$ mysql -u root -p
Enter password:
```



### 查询缓存（mysql 8 之后废除, 暂不讨论）



### 分析器

作用：`mysql` 需要知道你做什么

分析器是如何工作的？假设我们输入了一条语句：

```mysql
mysql> select * from T where ID=10；
```

1. 词法分析

   将关键字识别出来，例如 `select`, `T` 和 `ID`

2. 语法分析 

   判断语句是否符合 `mysql` 语法

### 优化器

作用：`mysql` 需要知道如何做

优化器是如何工作的？假设我们输入了一条语句：

```mysql
mysql> select * from t1 join t2 using(ID)  where t1.c=10 and t2.d=20;
```

既可以从 `t1` 表取出 `c` = 10 的记录的 `ID` 值，再关联到 `t2` 表，再判断 `t2` 里 `d` 的值是否等于 20，也可以反过来

这两种方法的逻辑结果是相同的，但执行效率不同，优化器就是决定选择哪种方案的



### 执行器

`mysql` 知道了语句的意思，也知道该如何做了，接下来就剩下执行语句了



开始执行之前，先要判断操作者对该表是否有执行查询 / 更新的权限

若有权限（没有权限则直接打回），就打开表直接执行，根据该引擎插件选择其提供的接口



举个例子：

```mysql
mysql> select * from T where ID=10；
```



1. 调用 `InnoDB` 引擎接口取这个表的第一行，判断 `ID` 值是否为 10，若不是则跳过，若有则存在结果集中
2. 遍历
3. 将结果集返回给客户端



## 2. 一条 SQL 更新语句是如何执行的?

了解了查询的基本流程，再看看更新语句

举个例子，创建表 `T`

```mysql
mysql> create table T(ID int primary key, c int);
```

更新数据：

```mysql
mysql> update T set c=c+1 where ID=2;
```

流程跟查询有类似，经过连接器，分析器，执行器

但与查询流程不一样的是，更新流程还涉及到两个重要的日志模块：

- redo log（重做日志）
- binlog（归档日志）



下面先看一个例子：

<div align="center"> <img src="image-20201015200534724.png" width="80%"/> </div><br> 


### redo log

具体来说，当有一条记录需要更新的时候，`InnoDB` 就会先把记录写到 `redo log`（粉板），并更新内存（保证数据实时性），这个时候更新就算完成。在适当的时候，`InnoDB` 将这个操作更新到磁盘中（打烊后掌柜将粉板的记录更新到汇总账单）



<div align="center"> <img src="redo.png" width="60%"/> </div><br> 

值得注意的是：

- `InnoDB` 的 `redo log` 是固定大小的，这块粉板总共可以记录 4GB 的操作
- 有了 `redo log`，`InnoDB` 可以保证即使数据库发生异常重启，之前提交的记录都不会丢失，称为 `crash-safe`



### binlog







## 3. 事务隔离: 为什么你改了我还看不见?





## 4. 深入浅出索引



## 5. 全局锁和表锁: 给表加个字段怎么有那么多阻碍?



## 6. 怎么减少行锁对性能对影响?

## 7. 事务到底是隔离的还是不隔离的?



## 8. 普通索引和唯一索引, 应该怎么选择?

## 9. MySQL 为什么有时候会选错索引?



## 10. 怎么给字符串字段加索引?



## 11. 为什么我的 MySQL 会 ”抖“ 一下?



## 12. 为什么表数据删掉一半, 表文件大小不变?





## 13. count(*) 这么慢, 怎么办?







## 14. "order by" 如何工作?









## 15. 如何正确显示随机消息?





## 16. 为什么 SQL 语句逻辑相同, 性能差异却巨大?







## 17. 为什么我只查一行的语句, 也执行那么慢?



## 18. 幻读是什么? 有什么问题?







## 19. 为什么我只查一行的语句, 锁这么多?









## 20. 有哪些提高性能的方法?







## 21. 如何保证数据不丢?





## 22. 如何保证主备一致?





## 23. 如何保证高可用?



## 24. 备库为什么会延迟好几个小时?





## 25. 主库出问题了, 从库怎么办?



## 26. 读写分离有哪些坑?





## 27. 如何判断一个数据库是不是出问题了?



## 28. 删库除了跑路, 还能怎么办?



## 29. 为什么还有 kill 不掉的语句?



## 30. 我查那么多数据, 会不会把数据库内存打爆？





## 31. 到底可不可以用 join?



## 32. join 语句怎么优化?



## 33. 为什么临时表可以重名?





## 34. 什么时候会使用内部临时表?



## 35. 还要使用 Memory 引擎吗?



## 36. 自增主键为什么不是连续的?



## 37. insert 语句的锁为什么那么多?



## 38. grant 之后要 flush privileges 吗?





## 39. 怎么最快地复制一张表?



## 40. 要不要使用分区表?

## 41. 自增 ID 用完了怎么办?



## 参考资料

- [MySQL实战45讲-极客时间](https://time.geekbang.org/column/intro/100020801)